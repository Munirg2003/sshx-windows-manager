name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  powershell-analysis:
    name: PSScriptAnalyzer
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run PSScriptAnalyzer
        shell: pwsh
        run: |
          $results = Invoke-ScriptAnalyzer -Path . -Recurse -Severity Error
          if ($results) {
              $results | Format-Table -AutoSize
              exit 1
          }
          Write-Host "No PSScriptAnalyzer errors found."

  shellcheck:
    name: ShellCheck (Linux/macOS)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run ShellCheck
        run: |
          # Check Linux script
          if [ -d "linux" ]; then
            shellcheck linux/*.sh || true
          fi
          # Check macOS script
          if [ -d "macos" ]; then
            shellcheck -s bash macos/*.zsh || true
          fi

  syntax-check:
    name: PowerShell Syntax Check
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Verify SSHX Manager Syntax
        shell: powershell
        run: |
          [scriptblock]::Create((Get-Content -Raw -Path "sshx-manager.ps1"))
          Write-Host "Syntax check passed for sshx-manager.ps1"